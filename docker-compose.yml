version: '3.8'

services:
  # ILP Connector
  ilp-connector:
    image: di3twater/crosstown-connector:latest
    container_name: wasteland-ilp-connector
    ports:
      - "7768:7768"  # ILP connector port
    environment:
      - CONNECTOR_STORE=memory
      - CONNECTOR_ACCOUNTS={}
      - CONNECTOR_ILP_ADDRESS=test.connector
    networks:
      - wasteland-net
    restart: unless-stopped
    mem_limit: 512m
    cpus: 1.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7768/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Crosstown Relay (ILP-gated Nostr relay)
  relay:
    image: di3twater/crosstown-relay:latest
    container_name: wasteland-relay
    ports:
      - "7001:7001"  # Nostr relay WebSocket port
    environment:
      - RELAY_NAME=wasteland-relay
      - RELAY_DESCRIPTION=Wasteland POC Nostr Relay
      - ILP_CONNECTOR=http://ilp-connector:7768
      - RELAY_PUBLIC_KEY=${RELAY_PUBLIC_KEY:-}
    depends_on:
      ilp-connector:
        condition: service_healthy
    networks:
      - wasteland-net
    restart: unless-stopped
    mem_limit: 1g
    cpus: 2.0
    volumes:
      - relay-data:/data

  # Demo Agent 1
  agent-1:
    build:
      context: .
      dockerfile: packages/demo-agent/Dockerfile
    container_name: wasteland-agent-1
    environment:
      - AGENT_NAME=agent-1
      - RELAY_URL=ws://relay:7001
      - POLLING_INTERVAL=5000
      - WORK_DURATION_MIN=2
      - WORK_DURATION_MAX=5
    depends_on:
      - relay
    networks:
      - wasteland-net
    restart: unless-stopped
    mem_limit: 256m
    cpus: 0.5
    command: start

  # Demo Agent 2
  agent-2:
    build:
      context: .
      dockerfile: packages/demo-agent/Dockerfile
    container_name: wasteland-agent-2
    environment:
      - AGENT_NAME=agent-2
      - RELAY_URL=ws://relay:7001
      - POLLING_INTERVAL=5000
      - WORK_DURATION_MIN=2
      - WORK_DURATION_MAX=5
    depends_on:
      - relay
    networks:
      - wasteland-net
    restart: unless-stopped
    mem_limit: 256m
    cpus: 0.5
    command: start

  # Demo Agent 3
  agent-3:
    build:
      context: .
      dockerfile: packages/demo-agent/Dockerfile
    container_name: wasteland-agent-3
    environment:
      - AGENT_NAME=agent-3
      - RELAY_URL=ws://relay:7001
      - POLLING_INTERVAL=5000
      - WORK_DURATION_MIN=2
      - WORK_DURATION_MAX=5
    depends_on:
      - relay
    networks:
      - wasteland-net
    restart: unless-stopped
    mem_limit: 256m
    cpus: 0.5
    command: start

networks:
  wasteland-net:
    driver: bridge

volumes:
  relay-data:
